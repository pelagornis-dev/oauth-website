---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <div class="w-full max-w-sm mx-auto">
    <h1 class="text-2xl font-bold text-black text-center mb-2">Reset Password</h1>
    <p class="text-center text-gray-500 mb-8 text-sm">
      가입하신 이메일로 비밀번호 재설정 링크를 보내드립니다.
    </p>
    <form
      id="reset-form"
      class="space-y-5"
      autocomplete="off"
      method="POST"
      action="http://localhost:3000/api/v1/auth/reset-password?locale=ko"
    >
      <input
        type="password"
        name="oldPassword"
        id="reset-old-password"
        placeholder="기존 비밀번호"
        required
        autocomplete="current-password"
        class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:border-black focus:bg-white focus:ring-2 focus:ring-black focus:outline-none transition text-black placeholder-gray-400"
      />
      <input
        type="password"
        name="newPassword"
        id="reset-new-password"
        placeholder="새 비밀번호"
        required
        autocomplete="new-password"
        class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:border-black focus:bg-white focus:ring-2 focus:ring-black focus:outline-none transition text-black placeholder-gray-400"
      />
      <input
        type="password"
        name="confirmPassword"
        id="reset-confirm-password"
        placeholder="새 비밀번호 확인"
        required
        autocomplete="new-password"
        class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:border-black focus:bg-white focus:ring-2 focus:ring-black focus:outline-none transition text-black placeholder-gray-400"
      />
      <div id="reset-error" class="text-red-500 text-sm mt-2 hidden"></div>
      <button
        id="reset-btn"
        type="submit"
        class="w-full py-3 rounded-xl bg-black text-white font-semibold hover:bg-neutral-900 transition disabled:opacity-60"
      >
        비밀번호 재설정
      </button>
      <div id="reset-success" class="text-green-600 text-sm mt-2 hidden"></div>
    </form>
    <div class="flex justify-between mt-8 text-sm">
      <a href="/login" class="text-black hover:underline">로그인</a>
      <a href="/register" class="text-gray-500 hover:underline">회원가입</a>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('reset-form') as HTMLFormElement | null;
      const oldPwInput = document.getElementById('reset-old-password') as HTMLInputElement | null;
      const newPwInput = document.getElementById('reset-new-password') as HTMLInputElement | null;
      const confirmInput = document.getElementById(
        'reset-confirm-password',
      ) as HTMLInputElement | null;
      const btn = document.getElementById('reset-btn') as HTMLButtonElement | null;
      const errorDiv = document.getElementById('reset-error');
      const successDiv = document.getElementById('reset-success');

      // 쿼리에서 token 추출
      function getToken() {
        const params = new URLSearchParams(window.location.search);
        return params.get('token') || '';
      }

      function showError(msg) {
        if (errorDiv) {
          errorDiv.textContent = msg;
          errorDiv.classList.remove('hidden');
        }
      }
      function showSuccess(msg) {
        if (successDiv) {
          successDiv.textContent = msg;
          successDiv.classList.remove('hidden');
        }
      }
      function clearMsg() {
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
      }

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg();
        if (!oldPwInput || !newPwInput || !confirmInput || !btn || !form) return;
        const oldPw = oldPwInput.value;
        const newPw = newPwInput.value;
        const confirmPw = confirmInput.value;
        const token = getToken();
        if (!oldPw || !newPw || !confirmPw) {
          showError('모든 항목을 입력하세요.');
          return;
        }
        if (newPw !== confirmPw) {
          showError('새 비밀번호가 일치하지 않습니다.');
          confirmInput.classList.add('border-red-500');
          return;
        }
        if (!token) {
          showError('유효하지 않은 접근입니다.');
          return;
        }
        btn.disabled = true;
        btn.textContent = '재설정 중...';
        try {
          const response = await fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              oldPassword: oldPw,
              newPassword: newPw,
              token: token,
            }),
          });
          const data = await response.json();
          if (data.success) {
            showSuccess('비밀번호가 성공적으로 변경되었습니다.');
            btn.textContent = '비밀번호 재설정';
            btn.disabled = false;
          } else {
            showError(data.error?.message || '재설정 실패');
            btn.textContent = '비밀번호 재설정';
            btn.disabled = false;
          }
        } catch {
          showError('Network error');
          btn.textContent = '비밀번호 재설정';
          btn.disabled = false;
        }
      });

      [oldPwInput, newPwInput, confirmInput].forEach((el) => {
        el?.addEventListener('input', () => {
          el.classList.remove('border-red-500');
          clearMsg();
        });
      });
    });
  </script>
</Layout>
