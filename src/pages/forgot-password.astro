---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <div class="w-full max-w-sm mx-auto">
    <h1 class="text-2xl font-bold text-black text-center mb-2">Forgot Password</h1>
    <p class="text-center text-gray-500 mb-8 text-sm">
      가입하신 이메일로 비밀번호 재설정 링크를 보내드립니다.
    </p>
    <form
      id="forgot-form"
      class="space-y-5"
      autocomplete="off"
      method="POST"
      action="http://localhost:3000/api/v1/auth/forgot-password?locale=ko"
    >
      <input
        type="email"
        name="email"
        id="forgot-email"
        placeholder="이메일"
        required
        autocomplete="username"
        class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 focus:border-black focus:bg-white focus:ring-2 focus:ring-black focus:outline-none transition text-black placeholder-gray-400"
      />
      <div id="forgot-error" class="text-red-500 text-sm mt-2 hidden"></div>
      <div id="forgot-success" class="text-green-600 text-sm mt-2 hidden"></div>
      <button
        id="forgot-btn"
        type="submit"
        class="w-full py-3 rounded-xl bg-black text-white font-semibold hover:bg-neutral-900 transition disabled:opacity-60"
      >
        재설정 메일 보내기
      </button>
    </form>
    <div class="flex justify-between mt-8 text-sm">
      <a href="/login" class="text-black hover:underline">로그인</a>
      <a href="/register" class="text-gray-500 hover:underline">회원가입</a>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('forgot-form') as HTMLFormElement | null;
      const emailInput = document.getElementById('forgot-email') as HTMLInputElement | null;
      const btn = document.getElementById('forgot-btn') as HTMLButtonElement | null;
      const resendBtn = document.getElementById('resend-btn') as HTMLButtonElement | null;
      const errorDiv = document.getElementById('forgot-error');
      const successDiv = document.getElementById('forgot-success');
      let lastEmail = '';
      function showError(msg: string) {
        if (errorDiv) {
          errorDiv.textContent = msg;
          errorDiv.classList.remove('hidden');
        }
      }
      function showSuccess(msg: string) {
        if (successDiv) {
          successDiv.textContent = msg;
          successDiv.classList.remove('hidden');
        }
      }
      function clearMsg() {
        if (errorDiv) errorDiv.classList.add('hidden');
        if (successDiv) successDiv.classList.add('hidden');
      }
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg();
        if (!emailInput || !btn || !form || !resendBtn) return;
        const emailVal = emailInput.value.trim();
        if (emailVal && emailVal.includes('@')) {
          btn.disabled = true;
          btn.textContent = '전송 중...';
          try {
            const response = await fetch(form.action, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: emailVal }),
            });
            const data = await response.json();
            if (data.success) {
              showSuccess('이메일로 재설정 링크를 보냈습니다.');
              btn.textContent = '재설정 메일 보내기';
              btn.disabled = false;
              lastEmail = emailVal;
              resendBtn.disabled = false;
            } else {
              showError(data.error?.message || '전송 실패');
              btn.textContent = '재설정 메일 보내기';
              btn.disabled = false;
            }
          } catch {
            showError('Network error');
            btn.textContent = '재설정 메일 보내기';
            btn.disabled = false;
          }
        } else {
          showError('올바른 이메일을 입력하세요.');
          emailInput.classList.add('border-red-500');
        }
      });
      resendBtn?.addEventListener('click', async () => {
        clearMsg();
        if (!lastEmail || !form || !resendBtn) return;
        resendBtn.disabled = true;
        try {
          const response = await fetch(form.action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: lastEmail }),
          });
          const data = await response.json();
          if (data.success) {
            showSuccess('이메일로 재설정 링크를 다시 보냈습니다.');
          } else {
            showError(data.error?.message || '전송 실패');
          }
        } catch {
          showError('Network error');
        }
        resendBtn.disabled = false;
      });
      emailInput?.addEventListener('input', () => {
        emailInput.classList.remove('border-red-500');
        clearMsg();
      });
    });
  </script>
</Layout>
